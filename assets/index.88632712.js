var De=Object.defineProperty;var Ee=(l,e,t)=>e in l?De(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var c=(l,e,t)=>(Ee(l,typeof e!="symbol"?e+"":e,t),t);import{d as se,o as h,c as v,u as a,R as Le,r as M,a as q,b as B,e as z,w as we,f as _,D as Se,C as le,g as _e,h as $,i as Ae,j as g,t as A,k as S,l as Y,m as I,n as ue,F as J,p as X,q as Z,s as Ie,v as W,x as pe,y as ge,z as ie,A as ye,B as te,E as Me,G as Ce,H as ke,I as Ne,J as We,K as Pe}from"./vendor.d61edce2.js";const Re=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function t(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerpolicy&&(s.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?s.credentials="include":i.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=t(i);fetch(i.href,s)}};Re();const $e=se({setup(l){return(e,t)=>(h(),v(a(Le)))}});class Oe{constructor(){c(this,"src");c(this,"startTime");c(this,"endTime");c(this,"paused",!0)}setAudioTimes(e,t){return this.startTime=e,this.endTime=t,this}play(){return this.paused=!1,this}pause(){return this.paused=!0,this}getCurrentTime(){}}const Fe=M(new Oe),O=()=>Fe,Be=["src"],Ve={setup(l){const e=q(null),t=O();t.getCurrentTime=()=>e.value.currentTime;let n,i,s;const r=()=>{e.value.paused&&(e.value.play(),t.play(),u())},u=()=>{if(clearTimeout(s),i&&!e.value.paused){let b=i-e.value.currentTime;s=window.setTimeout(()=>{L(),f()},b*1e3)}},f=()=>{n&&(e.value.currentTime=n)},w=()=>{e.value.paused?r():L()},m=()=>{f(),u(),r()},L=()=>{e.value.paused||(e.value.pause(),t.pause(),u())},D=b=>{b.target instanceof HTMLInputElement||b.target instanceof HTMLTextAreaElement||(b.key==="p"?w():b.key==="r"&&m())};return B(()=>{document.addEventListener("keydown",D)}),z(()=>{document.removeEventListener("keydown",D)}),we(t,()=>{(n!==t.startTime||i!==t.endTime)&&(n=t.startTime,i=t.endTime,f(),u()),e.value.paused!==t.paused&&w()}),(b,k)=>(h(),_("audio",{controls:"",src:a(t).src,ref_key:"audio",ref:e},null,8,Be))}};class Te{constructor(e,t=""){c(this,"id");c(this,"sentence");c(this,"definition");c(this,"mastery");c(this,"startTime");c(this,"endTime");this.sentence=e,this.definition=t,this.mastery=0}getRawWords(){return this.sentence.split(/\s+/).filter(e=>e!=="")}updateTimes(e,t){Number.isNaN(e)||(this.startTime=e),Number.isNaN(t)||(this.endTime=t)}}const R=class{constructor(e,t){c(this,"word");c(this,"definition");c(this,"mastery");c(this,"sentenceId");this.word=e,this.sentenceId=t,this.definition="",this.mastery=0}updateMastery(e){return this.mastery|=e,this}hasMastery(e){return this.mastery&e}isDefined(){return this.mastery&R.MASTERY_LEVELS.DEFINED}isMastered(){return this.mastery===R.FULL_MASTERY}setDefinition(e){this.definition=e,this.updateMastery(R.MASTERY_LEVELS.DEFINED)}getMasteryPercentage(){let e=0;for(let t=1;t<=R.MASTERY_LEVELS.LISTENING2;t<<=1)t&this.mastery&&(e+=1);return e/R.MASTERY_LEVEL_COUNT}getNewCount(){return this.isDefined()?1:0}};let x=R;c(x,"MASTERY_LEVELS",{DEFINED:1<<0,VOCAB_IN_CONTEXT:1<<1,VOCAB_MATCHING:1<<2,CLOZE:1<<3,LISTENING1:1<<4,LISTENING2:1<<5}),c(x,"MASTERY_LEVEL_COUNT",6),c(x,"FULL_MASTERY",63);class E{static randomWordsByMastery(e,t){const n=Array.from(e.values()).filter(u=>u.definition!=="");if(n.length<t)return[];const i=n.map(u=>u.mastery);let s=Math.min(...i),r=[];for(;r.length<t;){const u=n.filter(f=>f.mastery===s);E.shuffle(u),r=r.concat(u.slice(0,t-r.length)),s+=1}return r}static cleanWord(e){const t=e.match(/\p{Letter}+/u);return t?t[0].toLowerCase():""}static shuffle(e){for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}}static randomItem(e){const t=Math.floor(Math.random()*e.length);return e[t]}static createHTML(e){const[t,...n]=e,i=document.createElement(t);for(const s in n){const r=n[s];if(Array.isArray(r))i.append(this.createHTML(r));else if(typeof r=="string"||typeof r=="number"||r instanceof Element)i.append(r);else if(typeof r=="object")for(const u in r)i[u]=r[u]}return i}static isEndChar(e){return e==="..."?!1:e.match(/[.?!]/)!==null}static nextEndPos(e,t){for(;;){const n=e.substring(t,t+1);if(e.substring(t,t+3)==="..."){t+=3;continue}if(n==="")return!1;if(this.isEndChar(n))break;t+=1}for(;;){const n=e.substring(t+1,t+2);if(!this.isEndChar(n))break;t+=1}for(;e.substring(t+1,t+2).match(/[\sâ€œ]/)!==null;)t+=1;return t}static createDraggableItem(e){const t=document.createElement(e.tag);return t.id=e.id,t.classList.add("matching-item"),t.innerText=e.text,t.draggable=!0,t.addEventListener("drop",n=>{n.preventDefault();const i=document.getElementById(n.dataTransfer.getData("text/plain")),s=n.target;if(s.draggable===!1)return;const r=s.innerHTML;s.innerHTML=i.innerHTML,i.innerHTML=r,s.classList.remove("drag-over"),e.onDrop&&e.onDrop(i,s,e)}),t.addEventListener("dragenter",n=>{n.preventDefault(),n.target.draggable!==!1&&n.target.classList.add("drag-over")}),t.addEventListener("dragover",n=>{n.preventDefault(),n.target.draggable!==!1&&n.target.classList.add("drag-over")}),t.addEventListener("dragleave",n=>{n.target.classList.remove("drag-over")}),t.addEventListener("dragstart",n=>{n.dataTransfer.setData("text/plain",n.target.id)}),t}static benchmark(e){const t=new Date().getTime();e();const n=new Date().getTime();console.log((n-t)/1e3)}static download(e,t){const n=document.createElement("a");n.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),n.setAttribute("download",e),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}static upload(){const e=document.createElement("input");return e.setAttribute("type","file"),e.setAttribute("multiple",""),e.style.display="none",document.body.appendChild(e),new Promise(t=>{e.addEventListener("change",()=>{t(e.files||new FileList),e.remove()}),e.click()})}static async uploadText(){return(await E.upload())[0]}static async openFiles(){const e=await E.upload(),t={};for(let n=0;n<e.length;n++){const i=e[n];i.type==="text/plain"&&(t.text=i),(i.type==="audio/mpeg"||i.type==="audio/x-m4a")&&(t.audio=i)}return t}}class U{constructor(){c(this,"currentPage");c(this,"openAudioFile");c(this,"openTextFile");c(this,"date");c(this,"definedToday");c(this,"learnedToday");c(this,"masteredToday");c(this,"language");this.date=new Date().toLocaleDateString(),this.currentPage=0,this.definedToday=0,this.learnedToday=0,this.masteredToday=0,this.language="es"}static fromObject(e){const t=new U;return Object.assign(t,e),t}load(e){Object.assign(this,e)}updateForNewDay(){this.date=new Date().toLocaleDateString()}isNewDay(){return this.date!==new Date().toLocaleDateString()}openNewTextFile(e){this.openTextFile=e,this.currentPage=0}openNewAudioFile(e){this.openAudioFile=e}}const He=new U,re=()=>He;class fe{constructor(e,t,n,i){c(this,"date");c(this,"defined");c(this,"learned");c(this,"mastered");this.date=e,this.defined=t,this.learned=n,this.mastered=i}}class Ue{constructor(){c(this,"db");this.db=new Se("LanguageDB"),this.db.version(3).stores({words:"word, mastery",sentences:"++id, sentence",history:"date",other:"key"}),this.db.words.mapToClass(x),this.db.sentences.mapToClass(Te),this.db.history.mapToClass(fe)}getWord(e){return this.db.words.get(e)}getSentence(e){return this.db.sentences.where("sentence").equals(e).first()}getSentenceById(e){return this.db.sentences.get(e)}putWords(e){return this.db.words.bulkPut(e)}putSentence(e){return console.log("Updating sentence",e),this.db.sentences.put(e)}async import(e){return await this.db.words.clear(),await this.db.sentences.clear(),await this.db.history.clear(),await this.db.other.delete("runtimeData"),console.log("importing words"),await this.putWords(e.words),console.log("done importing words"),console.log("importing sentences"),await this.db.sentences.bulkPut(e.sentences),console.log("done importing sentences"),await this.db.history.bulkPut(e.history),await this.db.other.put({key:"runtimeData",value:e.runtimeData}),console.log("done import"),"done"}async export(){const e=await this.db.words.toArray(),t=await this.db.sentences.toArray(),n=await this.getRuntimeData(),i=await this.getHistory();return{runtimeData:n,sentences:t,words:e,history:i}}getRuntimeData(){return this.db.other.get("runtimeData").then(e=>e===void 0?new U:U.fromObject(e.value))}putRuntimeData(e){console.log("Saving runtime data",e),this.db.other.put({key:"runtimeData",value:e})}getTextFile(){return this.db.other.get("textFile").then(e=>e===void 0?void 0:e.value)}putTextFile(e){this.db.other.put({key:"textFile",value:e})}getAudioFile(){return this.db.other.get("audioFile").then(e=>e===void 0?void 0:e.value)}putAudioFile(e){this.db.other.put({key:"audioFile",value:e})}async getSentencesForWords(e){const t=await this.db.sentences.bulkGet(e.map(n=>n.sentenceId));return new Map(t.map(n=>[n.id,n]))}async getPracticeByType(e){const n=(await this.db.words.where("mastery").notEqual(x.FULL_MASTERY).toArray()).filter(i=>i.isDefined()&&!i.hasMastery(e));return E.shuffle(n),n}async getMasteryCounts(){const e=await this.db.words.where("mastery").notEqual(x.FULL_MASTERY).toArray(),t={},n=Object.values(x.MASTERY_LEVELS);return n.forEach(i=>{t[i]=0}),e.forEach(i=>{n.forEach(s=>{i.isDefined()&&!i.hasMastery(s)&&(t[s]+=1)})}),t}async getAllWords(){return await this.db.words.toArray()}async getDefinedSentences(){return(await this.db.sentences.toArray()).filter(e=>e.definition!=="")}async getHistory(){return(await this.db.history.toArray()).sort((e,t)=>{const n=new Date(e.date),i=new Date(t.date);return n.getTime()-i.getTime()})}async putHistoryDay(e){return this.db.history.put(e)}async getStatistics(e=void 0){const t=await xe.getAllWords();e===void 0&&(e=new Date().toLocaleDateString());const n=new fe(e,0,0,0);return t.forEach(i=>{i.isDefined()&&(n.defined+=1),i.isMastered()&&(n.mastered+=1),n.learned+=i.getMasteryPercentage()}),n}async getLastStatistics(){return this.db.history.toCollection().last()}}const xe=new Ue,G=()=>xe,Ye={key:0,id:"stats-modal"},Ge=g("td",null,"Words Defined",-1),je=g("td",null,"Defined Today",-1),Xe={emits:["hide"],setup(l,{emit:e}){le.register(..._e);const t=q(null),n=G(),i=M({history:[],defined:0,learned:0,mastered:0,definedToday:0,learnedToday:0,masteredToday:0,loading:!0});return $(async()=>{const s=await n.getStatistics();i.history=await n.getHistory();const r=i.history[i.history.length-1];i.history.push(s),i.defined=s.defined,i.learned=s.learned,i.mastered=s.mastered,r===void 0?(i.definedToday=s.defined,i.learnedToday=s.learned,i.masteredToday=s.mastered):(i.definedToday=s.defined-r.defined,i.learnedToday=s.learned-r.learned,i.masteredToday=s.mastered-r.mastered),i.loading=!1}),Ae(()=>{!t.value||new le(t.value,{type:"line",data:{labels:i.history.map(s=>new Date(s.date)),datasets:[{label:"Defined",data:i.history.map(s=>s.defined)}]},options:{scales:{y:{beginAtZero:!0},x:{type:"time"}}}})}),(s,r)=>a(i).loading?S("",!0):(h(),_("div",Ye,[g("div",null,[g("table",null,[g("tbody",null,[g("tr",null,[Ge,g("td",null,A(a(i).defined),1)]),g("tr",null,[je,g("td",null,A(a(i).definedToday),1)])])])]),g("div",null,[g("canvas",{ref_key:"chart",ref:t,width:"400",height:"200"},null,512)]),g("button",{onClick:r[0]||(r[0]=u=>e("hide"))},"Hide")]))}},qe={class:"sidebar"},Ze={class:"sidebar-group"},ze=["value"],Je={class:"sidebar-group"},Ke={class:"sidebar-group"},Qe=se({props:["runtimeData"],emits:["updateLanguage","importDatabase","exportDatabase","openFiles","changeActivity"],setup(l,{emit:e}){const t=l,n=M({isShowingStatistics:!1});return Y(()=>console.log("Sidebar will update",t)),(i,s)=>(h(),_("div",qe,[g("div",Ze,[g("h3",null,A(t.runtimeData.openTextFile),1),g("h4",null,A(t.runtimeData.openAudioFile),1),I(Ve),g("button",{onClick:s[0]||(s[0]=r=>i.$emit("openFiles"))},"Open Files"),g("input",{value:t.runtimeData.language,onChange:s[1]||(s[1]=r=>e("updateLanguage",r.target.value)),placeholder:"Language",type:"text"},null,40,ze)]),g("div",Je,[g("button",{onClick:s[2]||(s[2]=r=>a(n).isShowingStatistics=!0)},"Show Statistics"),a(n).isShowingStatistics?(h(),v(Xe,{key:0,onHide:s[3]||(s[3]=r=>a(n).isShowingStatistics=!1)})):S("",!0)]),g("div",Ke,[g("button",{onClick:s[4]||(s[4]=r=>e("exportDatabase"))},"Export Database"),g("button",{onClick:s[5]||(s[5]=r=>e("importDatabase"))},"Import Database")])]))}}),et={id:"main"},V=se({props:["title","subtitle"],setup(l){return(e,t)=>(h(),_(J,null,[g("div",et,[g("h2",null,A(l.title),1),g("h3",null,A(l.subtitle),1),ue(e.$slots,"activity")]),ue(e.$slots,"sidebar")],64))}}),K={props:["sentences","wordMap","selectedWordIndex","selectedSentenceIndex","highlighting","wordOptions"],emits:["selectWord"],setup(l,e){const t=n=>{if(l.wordMap===void 0)return"";let i=l.wordMap.get(n);return!l.highlighting||!i.isDefined()?{backgroundColor:""}:{backgroundColor:"hsl(120,100%,75%)"}};return()=>{let n=0;if(l.sentences===void 0)return X("p");let i=l.sentences.map((s,r)=>{let f=s.getWordsAndSpaces().map(m=>{if(m.trim()==="")return m;let L=E.cleanWord(m);if(L==="")return m;let D=n;n+=1;let b=l.selectedWordIndex===D,k={selected:b},C=m;if(l.wordOptions){const d=l.wordOptions(m,L);d.bold&&(k.bold=!0),d.blank&&(C="__________")}let o={key:D,style:b?"":t(L),class:k,onClick(){e.emit("selectWord",D)}};return X("span",o,C)});const w={selected:l.selectedSentenceIndex===r};return X("span",{key:r,class:w},f)});return X("p",{className:l.highlighting?"highlight":""},i)}}},tt={id:"props.id"},he={props:["tag","text","focus","definition","language"],emits:["next","definitionUpdate"],setup(l,{emit:e}){const t=l,n=Z(()=>t.tag?t.tag:"input"),i=q(null),s=q(t.definition),r=f=>{f.key==="Tab"&&(f.preventDefault(),f.target.blur(),e("next")),f.stopPropagation()},u=()=>{const f=t.text,w="https://translate.googleapis.com/translate_a/single?client=gtx&sl="+t.language+"&tl=en&dt=t&q="+encodeURI(f);fetch(w).then(m=>m.json()).then(m=>{s.value=m[0].map(([L])=>L).join(""),i.value.focus()})};return B(()=>{t.focus&&i.value.focus()}),(f,w)=>(h(),_("div",tt,[g("span",null,A(t.text),1),(h(),v(Ie(a(n)),{ref_key:"definitionInput",ref:i,type:"text",placeholder:"Definition",value:s.value,onInput:w[0]||(w[0]=m=>s.value=m.target.value),onBlur:w[1]||(w[1]=m=>e("definitionUpdate",t.text,s.value)),onKeydown:r},null,8,["value"])),g("button",{onClick:u},"Google Translate")]))}};class nt{constructor(e){c(this,"wordIndex");c(this,"text");this.text=e,this.wordIndex=void 0}nextSentence(){if(this.wordIndex===void 0)return;const e=this.text().sentenceIndexByWordIndex,t=e[this.wordIndex];for(;;)if(this.wordIndex===this.text().words.length-1||(this.wordIndex+=1,e[this.wordIndex]!==t))return}nextWord(){this.wordIndex!==void 0&&this.wordIndex!==this.text().words.length-1&&(this.wordIndex+=1)}selectedWord(){return this.wordIndex===void 0?{}:this.text().words[this.wordIndex]}selectedSentence(){if(this.wordIndex===void 0)return{};const e=this.text().sentenceIndexByWordIndex[this.wordIndex],t=this.text().sentences[e].clean;return this.text().sentenceMap.get(t)}setIndex(e){this.wordIndex=e}getIndex(){return this.wordIndex}}const st={class:"footer"},it={class:"sidebar right"},rt={class:"sidebar-group"},at={class:"sidebar-group"},ot={class:"sidebar-group"},dt={props:["languageText","runtimeData"],emits:["setPage"],setup(l,{emit:e}){const t=l,n=O(),i=()=>{const o=t.languageText.getDefinitionArray();return o.filter(d=>d!=="").length/o.length},s=M({selectedWordCursor:new nt(()=>t.languageText),highlighting:!1,page:t.runtimeData.currentPage,marker:void 0,defined:i()}),r=Z(()=>s.selectedWordCursor.selectedWord()),u=Z(()=>s.selectedWordCursor.selectedSentence()),f=(...o)=>{t.languageText.updateWordDefinition(...o),s.defined=i()},w=(...o)=>t.languageText.updateSentenceDefinition(...o),m=o=>{e("setPage",t.runtimeData.currentPage+o)},L=o=>{e("setPage",Number(o.target.value)-1)},D=()=>{const o=t.languageText.sentences,d=t.languageText.sentenceMap;if(o.length===0)return;const p=o[0].clean,T=o[o.length-1].clean,N=d.get(p).startTime,P=d.get(T).endTime;n.setAudioTimes(N,P),n.pause()},b=()=>{t.runtimeData.currentPage!==s.page&&(s.selectedWordCursor.setIndex(void 0),s.page=t.runtimeData.currentPage)},k=()=>{s.marker===void 0?(n.play(),s.marker=0):s.marker+=1;let o=t.languageText.sentences;if(s.marker>0){let T=o[s.marker-1],N=t.languageText.sentenceMap.get(T.clean);t.languageText.updateSentenceTimes(N,null,n.getCurrentTime())}if(s.marker===o.length){n.pause(),s.marker=void 0;return}let d=o[s.marker],p=t.languageText.sentenceMap.get(d.clean);t.languageText.updateSentenceTimes(p,n.getCurrentTime(),null)},C=o=>{o.target instanceof HTMLInputElement||o.target instanceof HTMLTextAreaElement||o.key==="m"&&k()};return B(()=>{document.addEventListener("keydown",C)}),z(()=>{document.removeEventListener("keydown",C)}),Y(()=>{b(),D(),s.defined=i()}),$(()=>{D()}),(o,d)=>(h(),v(V,{title:"Reader",subtitle:`Page ${t.runtimeData.currentPage+1} of  ${l.languageText.pages.length}`},{activity:W(()=>[(h(),v(K,{sentences:t.languageText.sentences,"word-map":t.languageText.wordMap,key:t.runtimeData.currentPage,"selected-word-index":a(s).selectedWordCursor.getIndex(),"selected-sentence-index":a(s).marker,highlighting:a(s).highlighting,onSelectWord:d[0]||(d[0]=p=>a(s).selectedWordCursor.setIndex(p))},null,8,["sentences","word-map","selected-word-index","selected-sentence-index","highlighting"])),g("p",st,[g("strong",null,A((a(s).defined*100).toFixed(2)+"%"),1)])]),sidebar:W(()=>[g("div",it,[g("div",rt,[(h(),v(he,{id:"word-definition",key:a(r).word,text:a(r).word,focus:a(s).selectedWordCursor.getIndex()!==void 0,definition:a(r).definition,language:t.runtimeData.language,onDefinitionUpdate:f,onNext:d[1]||(d[1]=p=>a(s).selectedWordCursor.nextWord())},null,8,["text","focus","definition","language"])),(h(),v(he,{tag:"textarea",id:"sentence-definition",key:a(u).sentence,text:a(u).sentence,definition:a(u).definition,language:t.runtimeData.language,onDefinitionUpdate:w,onNext:d[2]||(d[2]=p=>a(s).selectedWordCursor.nextSentence())},null,8,["text","definition","language"]))]),g("div",at,[g("button",{onClick:d[3]||(d[3]=p=>m(-1))},"Previous Page"),g("button",{onClick:d[4]||(d[4]=p=>m(1))},"Next Page"),g("input",{placeholder:"Page",onInput:L},null,32)]),g("div",ot,[g("button",{onClick:d[5]||(d[5]=p=>a(s).highlighting=!a(s).highlighting)}," Toggle Highlighting ")])])]),_:1},8,["subtitle"]))}},ae={props:["sentence"],setup(l){const e=l,t=O(),n=G(),i=M({startTime:e.sentence.startTime,endTime:e.sentence.endTime});we(e,()=>{i.startTime=e.sentence.startTime,i.endTime=e.sentence.endTime});const s=u=>{if(u!=="")return Number.parseFloat(u)},r=()=>{let u=s(i.startTime),f=s(i.endTime);e.sentence.updateTimes(u,f),t.setAudioTimes(u,f),n.putSentence(ie(e.sentence))};return(u,f)=>(h(),_(J,null,[pe(g("input",{ref:"definitionInput",type:"number",placeholder:"Start Time","onUpdate:modelValue":f[0]||(f[0]=w=>a(i).startTime=w),onBlur:r},null,544),[[ge,a(i).startTime]]),pe(g("input",{ref:"definitionInput",type:"number",placeholder:"End Time","onUpdate:modelValue":f[1]||(f[1]=w=>a(i).endTime=w),onBlur:r},null,544),[[ge,a(i).endTime]])],64))}},ct=["onClick"],Q={props:["pool","solution"],emits:["correctAnswer"],setup(l,{emit:e}){const t=l;let n;const i=r=>{r===t.solution&&e("correctAnswer")},s=Z(()=>{const r=[t.solution];for(let u=0;u<20;u+=1){let f=E.randomItem(t.pool);if(r.indexOf(f)===-1&&r.push(f),r.length===4)break}return E.shuffle(r),r});return B(()=>{n=r=>{if(!(r.target instanceof HTMLInputElement||r.target instanceof HTMLTextAreaElement)&&["1","2","3","4"].indexOf(r.key)!==-1){r.preventDefault();let f=Number.parseInt(r.key)-1;i(s.value[f])}},document.addEventListener("keydown",n)}),z(()=>{document.removeEventListener("keydown",n)}),(r,u)=>(h(),_("div",null,[(h(!0),_(J,null,ye(a(s),(f,w)=>(h(),_("button",{key:"index",class:"multiple-choice",onClick:m=>i(f)},A(`${w+1}. ${f}`),9,ct))),128))]))}};class y{}c(y,"READER","Reader"),c(y,"VOCAB_IN_CONTEXT","Vocabulary in Context"),c(y,"VOCAB_MATCHING","Vocabulary Matching"),c(y,"CLOZE","Cloze"),c(y,"LISTENING1","Listening 1"),c(y,"LISTENING2","Listening 2");class ve{constructor(e,t,n=void 0){c(this,"raw");c(this,"clean");c(this,"sentenceId");this.raw=e,this.clean=t,this.sentenceId=n}getWords(){return this.clean.split(/\s+/).map(E.cleanWord).filter(e=>e!=="")}getWordsAndSpaces(){return this.raw.split(/(\s+)/)}}class lt{constructor(){c(this,"counts")}setCounts(e){this.counts=e}incrementAll(){Object.values(x.MASTERY_LEVELS).forEach(t=>{t!==x.MASTERY_LEVELS.DEFINED&&(this.counts[t]+=1)})}decrement(e){this.counts[e]-=1}getCount(e){return this.counts&&this.counts[e]}}const ut=M(new lt),oe=()=>ut,pt=oe(),F=G(),ne=re();class ee{constructor(e,t){c(this,"masteryLevel");c(this,"practiceWords");c(this,"wordIndex");c(this,"sentences");c(this,"wordPool");c(this,"sentencePool");c(this,"done");this.masteryLevel=e,this.practiceWords=[],this.wordIndex=0,this.sentences=new Map,this.wordPool=[],this.sentencePool=[],this.done=t}word(){return this.practiceWords[this.wordIndex]}sentence(){const e=this.word();if(e!==void 0)return this.sentences.get(e.sentenceId)}rawSentences(){const e=this.sentence();return e===void 0?[]:[new ve(e.sentence,e.sentence,e.id)]}correctAnswer(){const e=this.word();e.updateMastery(this.masteryLevel),F.putWords([ie(e)]),ne.learnedToday+=1/x.MASTERY_LEVEL_COUNT,ne.masteredToday+=e.isMastered()?1:0,F.putRuntimeData(ne),pt.decrement(this.masteryLevel),this.wordIndex+=1,this.wordIndex===this.practiceWords.length&&this.done()}async load(){const e=await F.getPracticeByType(this.masteryLevel),t=await F.getSentencesForWords(e),n=await F.getAllWords(),i=(await F.getDefinedSentences()).map(s=>s.definition);this.practiceWords=e,this.sentences=t,this.wordPool=n,this.sentencePool=i}}const gt={class:"sidebar right"},ft={class:"sidebar-group"},ht={emits:["done"],setup(l,{emit:e}){const t=O(),n=M(new ee(x.MASTERY_LEVELS.VOCAB_IN_CONTEXT,()=>e("done"))),i=(r,u)=>u===n.word().word?{bold:!0}:{},s=()=>n.wordPool.filter(r=>r.isDefined()).map(r=>r.definition);return $(()=>{n.load()}),Y(()=>{const r=n.sentence();t.setAudioTimes(r.startTime,r.endTime),t.play()}),(r,u)=>a(n).word()?(h(),v(V,{key:0,title:a(y).VOCAB_IN_CONTEXT},{activity:W(()=>[I(K,{sentences:a(n).rawSentences(),"word-options":i},null,8,["sentences"]),I(Q,{pool:s(),solution:a(n).word().definition,onCorrectAnswer:u[0]||(u[0]=()=>a(n).correctAnswer())},null,8,["pool","solution"])]),sidebar:W(()=>[g("div",gt,[g("div",ft,[I(ae,{sentence:a(n).sentence()},null,8,["sentence"])])])]),_:1},8,["title"])):S("",!0)}},mt={emits:["done"],setup(l,{emit:e}){const t=G(),n=re(),i=oe(),s=M({practiceWords:[],practiceIndex:0,words:[],grid:[]});$(async()=>{s.practiceWords=await t.getPracticeByType(x.MASTERY_LEVELS.VOCAB_MATCHING),b()}),B(()=>{document.addEventListener("keydown",C)}),z(()=>{document.removeEventListener("keydown",C)});const r=(o,d)=>s.grid[d][o],u=(o,d,p)=>{s.grid[d][o]=p},f=(o,d)=>{const p=r(o,d);return{"matching-item":!0,selected:p===void 0?!1:p.selected}},w=(o,d)=>{const p=r(o,d);return p===void 0?"":s.words[p.wordIndex].definition},m=o=>{for(let d=0;d<s.words.length;d++)for(let p=0;p<s.words.length;p++){const T=r(p,d);if(T&&o(T))return[p,d]}},L=()=>{const[o,d]=m(H=>H.selected),p=r(o,d),T=(p.shuffledIndex+1)%s.words.length,[N,P]=m(H=>H.shuffledIndex===T),ce=r(N,P);p.selected=!1,ce.selected=!0},D=(o,d)=>{const[p,T]=m(j=>j.selected),N=p+o,P=T+d;if(!(1<=N&&N<=2&&0<=P&&P<=s.words.length-1))return;const H=r(N,P);u(N,P,r(p,T)),u(p,T,H),k()&&(s.words.forEach(j=>{j.updateMastery(x.MASTERY_LEVELS.VOCAB_MATCHING),n.learnedToday+=1/x.MASTERY_LEVEL_COUNT,n.masteredToday+=j.isMastered()?1:0,i.decrement(x.MASTERY_LEVELS.VOCAB_MATCHING)}),t.putWords(s.words.map(ie)),t.putRuntimeData(n),b())},b=()=>{s.words=s.practiceWords.slice(s.practiceIndex,s.practiceIndex+8),s.words.length===0&&e("done");const o=s.words.map((d,p)=>p);E.shuffle(o),s.grid=o.map((d,p)=>[void 0,void 0,{wordIndex:d,shuffledIndex:p,selected:p===0}]),s.practiceIndex+=s.words.length},k=()=>{for(let o=0;o<s.words.length;o++){const d=r(1,o);if(d===void 0||d.wordIndex!==o)return!1}return!0},C=o=>{o.key==="Tab"&&(o.preventDefault(),L()),o.key==="ArrowDown"&&(o.preventDefault(),D(0,1)),o.key==="ArrowLeft"&&(o.preventDefault(),D(-1,0)),o.key==="ArrowUp"&&(o.preventDefault(),D(0,-1)),o.key==="ArrowRight"&&(o.preventDefault(),D(1,0)),o.stopPropagation()};return(o,d)=>a(s).practiceWords.length>0?(h(),v(V,{key:0,title:a(y).VOCAB_IN_CONTEXT},{activity:W(()=>[g("table",null,[(h(!0),_(J,null,ye(a(s).words,(p,T)=>(h(),_("tr",null,[g("td",{class:te(f(0,T))},A(p.word),3),g("td",{class:te(f(1,T))},A(w(1,T)),3),g("td",{class:te(f(2,T))},A(w(2,T)),3)]))),256))])]),_:1},8,["title"])):S("",!0)}},wt={emits:["done"],setup(l,{emit:e}){const t=M(new ee(x.MASTERY_LEVELS.CLOZE,()=>e("done"))),n=(s,r)=>r===t.word().word?{blank:!0}:{},i=()=>t.wordPool.map(s=>s.word);return $(()=>{t.load()}),(s,r)=>a(t).word()?(h(),v(V,{key:0,title:a(y).CLOZE},{activity:W(()=>[I(K,{sentences:a(t).rawSentences(),"word-options":n},null,8,["sentences"]),I(Q,{pool:i(),solution:a(t).word().word,onCorrectAnswer:r[0]||(r[0]=()=>a(t).correctAnswer())},null,8,["pool","solution"])]),_:1},8,["title"])):S("",!0)}},yt={class:"sidebar right"},Tt={class:"sidebar-group"},xt={emits:["done"],setup(l,{emit:e}){const t=O(),n=M(new ee(x.MASTERY_LEVELS.LISTENING1,()=>e("done"))),i=(r,u)=>u===n.word().word?{blank:!0}:{},s=()=>n.wordPool.map(r=>r.word);return $(()=>{n.load()}),Y(()=>{const r=n.sentence();t.setAudioTimes(r.startTime,r.endTime),t.play()}),(r,u)=>a(n).word()?(h(),v(V,{key:0,title:a(y).LISTENING1},{activity:W(()=>[I(K,{sentences:a(n).rawSentences(),"word-options":i},null,8,["sentences"]),I(Q,{pool:s(),solution:a(n).word().word,onCorrectAnswer:u[0]||(u[0]=()=>a(n).correctAnswer())},null,8,["pool","solution"])]),sidebar:W(()=>[g("div",yt,[g("div",Tt,[I(ae,{sentence:a(n).sentence()},null,8,["sentence"])])])]),_:1},8,["title"])):S("",!0)}},vt={class:"sidebar right"},bt={class:"sidebar-group"},Dt={emits:["done"],setup(l,{emit:e}){const t=O(),n=M(new ee(x.MASTERY_LEVELS.LISTENING2,()=>e("done")));return $(()=>{n.load()}),Y(()=>{const i=n.sentence();t.setAudioTimes(i.startTime,i.endTime),t.play()}),(i,s)=>a(n).sentence()?(h(),v(V,{key:0,title:a(y).LISTENING2},{activity:W(()=>[I(Q,{pool:a(n).sentencePool,solution:a(n).sentence().definition,onCorrectAnswer:s[0]||(s[0]=()=>a(n).correctAnswer())},null,8,["pool","solution"])]),sidebar:W(()=>[g("div",vt,[g("div",bt,[I(ae,{sentence:a(n).sentence()},null,8,["sentence"])])])]),_:1},8,["title"])):S("",!0)}};class Et{constructor(e,t,n,i,s){c(this,"filename");c(this,"totalWordsTranslated");c(this,"db");c(this,"pages");c(this,"text");c(this,"sentences");c(this,"sentenceMap");c(this,"sentenceIndexByWordIndex");c(this,"words");c(this,"wordMap");c(this,"promise");c(this,"onNewWordLearned");this.db=e,this.filename=t,this.totalWordsTranslated=0,this.pages=this.extractPages(n),this.onNewWordLearned=s,this.sentences=[],this.sentenceMap=new Map,this.words=[],this.wordMap=new Map,this.sentenceIndexByWordIndex=[],this.promise=new Promise(r=>r()),this.setPage(i)}async load(){await this.loadSentences(),await this.loadWords()}onUpdateDefinition(e){}setPage(e){return e<0||e>=this.pages.length?!1:(this.text=this.pages[e],!0)}extractPages(e){const n=[];let i=0,s=0,r=0,u=0;for(;u++,u!==1e3;){if(r=e.indexOf(`
`,s+1),r===-1){n.push(e.substring(i));break}if(r-i>1e3){const f=Math.abs(s-i-1e3),w=Math.abs(r-i-1e3),m=f<w?s:r;n.push(e.substring(i,m)),i=m}s=r}return n}async loadWords(){this.wordMap=new Map,this.words=[],this.sentenceIndexByWordIndex=[];let e=0;for(const t of this.sentences){const n=t.getWords();for(const i of n){let s=this.wordMap.get(i);s===void 0&&(s=await this.db.getWord(i)),s===void 0&&(s=new x(i,t.sentenceId)),s.sentenceId===void 0&&(s.sentenceId=t.sentenceId),this.words.push(s),this.wordMap.set(i,s),this.sentenceIndexByWordIndex.push(e)}await this.db.putWords([...this.wordMap.values()]),e+=1}}updateWordDefinition(e,t){const n=this.wordMap.get(e);n!==void 0&&n.definition!==t&&(n.isDefined()||(this.totalWordsTranslated+=1,this.onNewWordLearned()),n.setDefinition(t),console.log("Updating definition... for "+e+" to "+t),this.db.putWords([n]),this.onUpdateDefinition(e))}updateSentenceDefinition(e,t){const n=this.sentenceMap.get(e);n!==void 0&&n.definition!==t&&(n.definition=t,console.log("Updating definition... for "+e+" to "+t),this.db.putSentence(n))}updateMastery(e){e=e.map(t=>this.words.get(t).nextMastery()),this.db.putWords(e)}async loadSentences(){let e=0;for(this.sentences=[],this.sentenceMap=new Map,this.text===void 0&&(this.text="");;){const t=E.nextEndPos(this.text,e),n=this.text.substring(e,t===!1?void 0:t+1);if(n==="")break;const i=n.trim();if(this.sentences.push(new ve(n,i)),t===!1)break;e=t+1}for(const t of this.sentences){if(this.sentenceMap.has(t.clean))continue;let n=await this.db.getSentence(t.clean);n===void 0&&(n=new Te(t.clean),n.id=await this.db.putSentence(n)),this.sentenceMap.set(t.clean,n),t.sentenceId=n.id}}updateSentenceTimes(e,t,n){t!==null&&(e.startTime=t),n!==null&&(e.endTime=n),this.db.putSentence(e)}updateSentence(e){this.sentenceMap.set(e.sentence,e),this.db.putSentence(e)}getWordMap(e){const t=new Map;return e.forEach(n=>{t.set(n,this.words.get(n))}),t}getWordStrArray(){return Array.from(this.words).map(e=>e[1].word)}getSentenceDefinitionArray(){return Array.from(this.sentenceMap).map(e=>e[1].definition)}getDefinitionArray(){return this.words.map(e=>e.definition)}leastMasteredWord(e){const t=this.getWordMap(e.getWords());return E.randomWordsByMastery(t,1)[0]}leastMastery(){let e=x.MAX_MASTERY;return Array.from(this.words).forEach(([t,n])=>{n.definition!==""&&n.mastery<e&&(e=n.mastery)}),e}}const Lt=l=>{Me.addEventListener("statechange",()=>{console.log("Checking for new day"),l(),be(l.bind(globalThis))})};let me;const be=l=>{const e=new Date,n=new Date(e.getFullYear(),e.getMonth(),e.getDate()+1).getTime()-e.getTime();clearTimeout(me),me=setTimeout(()=>{l(),be(l)},n)},St={setup(l){const e=G(),t=Ce(void 0),n=O(),i=oe(),s=re(),r=M({runtimeData:s,activity:y.READER}),u=async()=>{if(Lt(C),r.runtimeData.load(await e.getRuntimeData()),await C(),i.setCounts(await e.getMasteryCounts()),console.log(r.runtimeData),r.runtimeData.openTextFile){const o=await e.getTextFile();t.value=await f(o)}if(r.runtimeData.openAudioFile){let o=await e.getAudioFile();o&&(n.src=URL.createObjectURL(o))}},f=async o=>{let d=new Et(e,r.runtimeData.openTextFile,o,r.runtimeData.currentPage,w);return await d.load(),d},w=()=>{s.definedToday+=1,s.learnedToday+=1/x.MASTERY_LEVEL_COUNT,i.incrementAll(),e.putRuntimeData(s)},m=async()=>{const o=await E.openFiles(),d=o.text,p=o.audio;if(d){const T=await d.text();r.runtimeData.openNewTextFile(d.name),t.value=await f(T),e.putTextFile(T)}p&&(r.runtimeData.openNewAudioFile(p.name),n.src=URL.createObjectURL(p),e.putAudioFile(p)),e.putRuntimeData(s)},L=async o=>{!t.value.setPage(o)||(await t.value.load(),r.runtimeData.currentPage=o,e.putRuntimeData(s))},D=o=>{r.runtimeData.language=o,e.putRuntimeData(s)},b=async()=>{const d=await(await E.uploadText()).text();await e.import(JSON.parse(d)),await u()},k=async()=>{let o=await e.export();E.download("language-db.json",JSON.stringify(o))},C=async()=>{if(r.runtimeData.isNewDay()){console.log("Updating for new day "+new Date);const o=await e.getStatistics(s.date);await e.putHistoryDay(o),r.runtimeData.updateForNewDay()}};return B(u),(o,d)=>(h(),_("div",null,[I(Qe,{"runtime-data":a(r).runtimeData,onOpenFiles:m,onUpdateLanguage:D,onImportDatabase:b,onExportDatabase:k,onChangeActivity:d[0]||(d[0]=p=>a(r).activity=p)},null,8,["runtime-data"]),a(r).activity===a(y).READER&&a(t)?(h(),v(dt,{key:0,"runtime-data":a(r).runtimeData,"language-text":a(t),onSetPage:L},null,8,["runtime-data","language-text"])):S("",!0),a(r).activity===a(y).VOCAB_IN_CONTEXT?(h(),v(ht,{key:1,onDone:d[1]||(d[1]=p=>a(r).activity=a(y).READER)})):S("",!0),a(r).activity===a(y).VOCAB_MATCHING?(h(),v(mt,{key:2,onDone:d[2]||(d[2]=p=>a(r).activity=a(y).READER)})):S("",!0),a(r).activity===a(y).CLOZE?(h(),v(wt,{key:3,onDone:d[3]||(d[3]=p=>a(r).activity=a(y).READER)})):S("",!0),a(r).activity===a(y).LISTENING1?(h(),v(xt,{key:4,onDone:d[4]||(d[4]=p=>a(r).activity=a(y).READER)})):S("",!0),a(r).activity===a(y).LISTENING2?(h(),v(Dt,{key:5,onDone:d[5]||(d[5]=p=>a(r).activity=a(y).READER)})):S("",!0)]))}},_t=ke({history:Ne("/language-reader-vue/"),routes:[{path:"/",name:"main",component:St}]}),de=We($e);de.use(Pe());de.use(_t);de.mount("#app");
